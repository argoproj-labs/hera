apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: retry-script-
spec:
  entrypoint: main
  templates:
  - name: main
    steps:
    - - name: safe-to-retry
        template: safe-to-retry
    - - name: retry
        template: retry-script
        arguments:
          parameters:
          - name: safe-to-retry
            value: '{{steps.safe-to-retry.outputs.result}}'
  - name: safe-to-retry
    script:
      image: python:alpine3.6
      source: |
        print("true")
      command:
      - python
  - name: retry-script
    inputs:
      parameters:
      - name: safe-to-retry
    retryStrategy:
      expression: asInt(lastRetry.exitCode) > 1 && lastRetry.status != "Error" &&
        asInt(lastRetry.duration) < 120 && ({{inputs.parameters.safe-to-retry}} ==
        true || lastRetry.message matches 'imminent node shutdown|pod deleted')
      limit: '10'
    script:
      image: python:alpine3.6
      source: |
        import random;
        import sys;
        exit_code = random.choice([1, 2]);
        sys.exit(exit_code)
      command:
      - python

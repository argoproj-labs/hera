apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: buildkit
spec:
  entrypoint: main
  templates:
  - name: main
    dag:
      tasks:
      - name: clone
        template: clone
        arguments:
          parameters:
          - name: repo
            value: '{{workflow.parameters.repo}}'
          - name: branch
            value: '{{workflow.parameters.branch}}'
      - name: build
        depends: clone
        template: build
        arguments:
          parameters:
          - name: path
            value: '{{workflow.parameters.path}}'
      - name: image
        depends: build
        template: image
        arguments:
          parameters:
          - name: path
            value: '{{workflow.parameters.path}}'
          - name: image
            value: '{{workflow.parameters.image}}'
  - name: clone
    container:
      image: alpine/git:v2.26.2
      workingDir: /work
      args:
      - clone
      - --depth
      - '1'
      - --branch
      - '{{inputs.parameters.branch}}'
      - --single-branch
      - '{{inputs.parameters.repo}}'
      - .
      volumeMounts:
      - name: work
        mountPath: /work
    inputs:
      parameters:
      - name: repo
      - name: branch
  - name: build
    container:
      image: golang:1.13
      workingDir: /work/{{inputs.parameters.path}}
      args:
      - build
      - -v
      - -o
      - argosay
      - ./...
      command:
      - go
      env:
      - name: GO111MODULE
        value: 'off'
      volumeMounts:
      - name: work
        mountPath: /work
    inputs:
      parameters:
      - name: path
  - name: image
    volumes:
    - name: docker-config
      secret:
        secretName: docker-config
    container:
      image: moby/buildkit:v0.9.3-rootless
      workingDir: /work/{{inputs.parameters.path}}
      args:
      - build
      - --frontend
      - dockerfile.v0
      - --local
      - context=.
      - --local
      - dockerfile=.
      - --output
      - type=image,name=docker.io/{{inputs.parameters.image}},push=true
      command:
      - buildctl-daemonless.sh
      env:
      - name: BUILDKITD_FLAGS
        value: --oci-worker-no-process-sandbox
      - name: DOCKER_CONFIG
        value: /.docker
      volumeMounts:
      - name: work
        mountPath: /work
      - name: docker-config
        mountPath: /.docker
      readinessProbe:
        exec:
          command:
          - sh
          - -c
          - buildctl debug workers
    inputs:
      parameters:
      - name: path
      - name: image
  volumeClaimTemplates:
  - metadata:
      name: work
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 64Mi
  arguments:
    parameters:
    - name: repo
      value: https://github.com/argoproj/argo-workflows
    - name: branch
      value: master
    - name: path
      value: test/e2e/images/argosay/v2
    - name: image
      value: alexcollinsintuit/argosay:v2

apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: map-reduce-
spec:
  arguments:
    parameters:
    - name: numParts
      value: '4'
  entrypoint: main
  templates:
  - dag:
      tasks:
      - arguments:
          parameters:
          - name: numParts
            value: '{{workflow.parameters.numParts}}'
        name: split
        template: split
      - arguments:
          artifacts:
          - name: part
            s3:
              key: '{{workflow.name}}/parts/{{item}}.json'
          parameters:
          - name: partId
            value: '{{item}}'
        depends: split
        name: map
        template: map
        withParam: '{{tasks.split.outputs.result}}'
      - depends: map
        name: reduce
        template: reduce
    name: main
  - inputs:
      parameters:
      - name: numParts
    name: split
    outputs:
      artifacts:
      - archive:
          none: {}
        name: parts
        path: /mnt/out
        s3:
          key: '{{workflow.name}}/parts'
    script:
      command:
      - python
      image: python:alpine3.6
      source: "import os\nimport sys\nsys.path.append(os.getcwd())\nimport json\n\
        try: numParts = json.loads(r'''{{inputs.parameters.numParts}}''')\nexcept:\
        \ numParts = r'''{{inputs.parameters.numParts}}'''\n\nimport json\nimport\
        \ os\nimport sys\nos.mkdir('/mnt/out')\npartIds = list(map(lambda x: str(x),\
        \ range({{inputs.parameters.numParts}})))\nfor (i, partId) in enumerate(partIds,\
        \ start=1):\n    with open('/mnt/out/' + partId + '.json', 'w') as f:\n  \
        \      json.dump({'foo': i}, f)\njson.dump(partIds, sys.stdout)"
  - inputs:
      artifacts:
      - name: part
        path: /mnt/in/part.json
      parameters:
      - name: partId
    name: map
    outputs:
      artifacts:
      - archive:
          none: {}
        name: part
        path: /mnt/out/part.json
        s3:
          key: '{{workflow.name}}/results/{{inputs.parameters.partId}}.json'
    script:
      command:
      - python
      image: python:alpine3.6
      source: "import os\nimport sys\nsys.path.append(os.getcwd())\nimport json\n\
        try: partId = json.loads(r'''{{inputs.parameters.partId}}''')\nexcept: partId\
        \ = r'''{{inputs.parameters.partId}}'''\n\nimport json\nimport os\nimport\
        \ sys\nos.mkdir('/mnt/out')\nwith open('/mnt/in/part.json') as f:\n    part\
        \ = json.load(f)\nwith open('/mnt/out/part.json', 'w') as f:\n    json.dump({'bar':\
        \ part['foo'] * 2}, f)"
  - inputs:
      artifacts:
      - name: results
        path: /mnt/in
        s3:
          key: '{{workflow.name}}/results'
    name: reduce
    outputs:
      artifacts:
      - archive:
          none: {}
        name: total
        path: /mnt/out/total.json
        s3:
          key: '{{workflow.name}}/total.json'
    script:
      command:
      - python
      image: python:alpine3.6
      source: "import os\nimport sys\nsys.path.append(os.getcwd())\nimport json\n\
        import os\nimport sys\ntotal = 0\nos.mkdir('/mnt/out')\nfor f in list(map(lambda\
        \ x: open('/mnt/in/' + x), os.listdir('/mnt/in'))):\n    result = json.load(f)\n\
        \    total = total + result['bar']\nwith open('/mnt/out/total.json', 'w')\
        \ as f:\n    json.dump({'total': total}, f)"

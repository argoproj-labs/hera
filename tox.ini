[tox]
envlist = py{37,38,39,310},coverage,lint,typecheck
isolated_build = true

[pytest]
addopts = --durations=5 -vv

[coverage:run]
branch = true
parallel = true

[coverage:report]
skip_covered = True
show_missing = True

[coverage:paths]
source = src/hera
    */.tox/*/lib/python*/site-packages/hera
    */.tox/pypy*/site-packages/hera
    */.tox\*\Lib\site-packages\hera
    */src/hera
    *\src\hera

[testenv]
wheel = true
setenv =
    ENABLE_BDIST_EXT_MODULE = {env:ENABLE_BDIST_EXT_MODULE:no}
    OS = {env:OS:}
    COVERAGE_FILE = {env:COVERAGE_FILE:{toxworkdir}/.coverage.{env:OS}.{envname}}
whitelist_externals = poetry
commands =
    poetry install
    poetry run python -m pytest \
        --cov "{envsitepackagesdir}/hera" \
        --cov-config "{toxinidir}/tox.ini"

[testenv:coverage]
setenv =
    COVERAGE_FILE = {toxworkdir}/.coverage
whitelist_externals = poetry
commands =
    poetry install
    poetry run coverage combine
    poetry run coverage report -m
    poetry run coverage xml -o {toxworkdir}/coverage.xml
    poetry run coverage html -d {toxworkdir}/htmlcov
depends = py37, py38, py39, py310

[testenv:lint]
skipsdist = True
skip_install = true
allowlist_externals =
    make
whitelist_externals = poetry
commands=
    poetry install
    poetry run make lint

[testenv:format]
whitelist_externals = poetry
commands =
    poetry install
    poetry run isort src tests examples conftest.py
    poetry run black --verbose src tests examples conftest.py

[testenv:typecheck]
skipsdist = True
allowlist_externals =
    make
whitelist_externals = poetry
commands=
    poetry install
    poetry run make typecheck

[gh-actions]
python =
    3.7: py37
    3.8: py38
    3.9: py39
    3.10: py310, lint, format, typecheck, coverage
